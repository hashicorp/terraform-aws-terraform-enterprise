%{ if cloud == "azurerm" ~}
function get_base64_secrets {
	local secret_id=$1
	# OS: Agnostic
	# Description: Pull the Base 64 encoded secrets from Azure Key Vault

	access_token=$(curl -s 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net' -H Metadata:true | jq -r .access_token)
	secret=$(curl -s --noproxy '*' $secret_id?api-version=2016-10-01 -H "x-ms-version: 2017-11-09" -H "Authorization: Bearer $access_token" | jq -r .value)

	if [[ -z "$secret" ]]; then
	    echo "Error: empty secrets for $secret_id" >&2
	    return 1
	fi

	echo $secret
}
%{ endif ~}

%{ if cloud == "aws" ~}
function get_base64_secrets {
	local secret_id=$1
	# OS: Agnostic
	# Description: Pull the Base 64 encoded secrets from AWS Secrets Manager

	secret=$(/usr/local/bin/aws secretsmanager get-secret-value --secret-id $secret_id | jq --raw-output '.SecretBinary,.SecretString | select(. != null)')

	if [[ -z "$secret" ]]; then
	    echo "Error: empty secrets for $secret_id" >&2
	    return 1
	fi

	echo $secret
}
%{ endif ~}

%{ if cloud == "google" ~}
get_base64_secrets () {
	local secret_id=$1
	# OS: Agnostic
	# Description: Pull the Base 64 encoded secrets from Google Secrets Manager

	secret=$(http_proxy="" https_proxy="" gcloud secrets versions access latest --secret="$secret_id")

	if [[ -z "$secret" ]]; then
	    echo "Error: empty secrets for $secret_id" >&2
	    return 1
	fi

	echo $secret
}
%{ endif ~}
